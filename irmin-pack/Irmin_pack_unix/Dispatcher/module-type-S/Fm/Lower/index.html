<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Lower (irmin-pack.Irmin_pack_unix.Dispatcher.S.Fm.Lower)</title><meta charset="utf-8"/><link rel="stylesheet" href="../../../../../../odoc.support/odoc.css"/><meta name="generator" content="odoc 2.4.2"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../../../../../odoc.support/highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body class="odoc"><nav class="odoc-nav"><a href="../index.html">Up</a> â€“ <a href="../../../../../index.html">irmin-pack</a> &#x00BB; <a href="../../../../index.html">Irmin_pack_unix</a> &#x00BB; <a href="../../../index.html">Dispatcher</a> &#x00BB; <a href="../../index.html">S</a> &#x00BB; <a href="../index.html">Fm</a> &#x00BB; Lower</nav><header class="odoc-preamble"><h1>Module <code><span>Fm.Lower</span></code></h1></header><div class="odoc-content"><div class="odoc-spec"><div class="spec module anchored" id="module-Io"><a href="#module-Io" class="anchor"></a><code><span><span class="keyword">module</span> Io</span><span> = <a href="../Io/index.html">Io</a></span></code></div></div><div class="odoc-spec"><div class="spec module anchored" id="module-Errs"><a href="#module-Errs" class="anchor"></a><code><span><span class="keyword">module</span> <a href="Errs/index.html">Errs</a></span><span> : <a href="../../../../Io_errors/module-type-S/index.html">Io_errors.S</a></span></code></div></div><div class="odoc-spec"><div class="spec module anchored" id="module-Volume"><a href="#module-Volume" class="anchor"></a><code><span><span class="keyword">module</span> <a href="Volume/index.html">Volume</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-t"><a href="#type-t" class="anchor"></a><code><span><span class="keyword">type</span> t</span></code></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-open_error"><a href="#type-open_error" class="anchor"></a><code><span><span class="keyword">type</span> open_error</span><span> = </span><span>[ </span></code><ol><li id="type-open_error.Volume.open_error" class="def variant type anchored"><a href="#type-open_error.Volume.open_error" class="anchor"></a><code><span>| </span><span><a href="Volume/index.html#type-open_error">Volume.open_error</a></span></code></li><li id="type-open_error.Volume_missing" class="def variant constructor anchored"><a href="#type-open_error.Volume_missing" class="anchor"></a><code><span>| </span><span>`Volume_missing <span class="keyword">of</span> string</span></code></li></ol><code><span> ]</span></code></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-close_error"><a href="#type-close_error" class="anchor"></a><code><span><span class="keyword">type</span> close_error</span><span> = </span><span>[ </span></code><ol><li id="type-close_error.Io.close_error" class="def variant type anchored"><a href="#type-close_error.Io.close_error" class="anchor"></a><code><span>| </span><span><a href="../Io/index.html#type-close_error">Io.close_error</a></span></code></li></ol><code><span> ]</span></code></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-volume_identifier"><a href="#type-volume_identifier" class="anchor"></a><code><span><span class="keyword">type</span> <span class="keyword">nonrec</span> volume_identifier</span><span> = string</span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-volume_identifier_t"><a href="#val-volume_identifier_t" class="anchor"></a><code><span><span class="keyword">val</span> volume_identifier_t : <span><a href="#type-volume_identifier">volume_identifier</a> <span class="xref-unresolved">Irmin</span>.Type.t</span></span></code></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-add_error"><a href="#type-add_error" class="anchor"></a><code><span><span class="keyword">type</span> add_error</span><span> = </span><span>[ </span></code><ol><li id="type-add_error.open_error" class="def variant type anchored"><a href="#type-add_error.open_error" class="anchor"></a><code><span>| </span><span><a href="#type-open_error">open_error</a></span></code></li><li id="type-add_error.Ro_not_allowed" class="def variant constructor anchored"><a href="#type-add_error.Ro_not_allowed" class="anchor"></a><code><span>| </span><span>`Ro_not_allowed</span></code></li><li id="type-add_error.Multiple_empty_volumes" class="def variant constructor anchored"><a href="#type-add_error.Multiple_empty_volumes" class="anchor"></a><code><span>| </span><span>`Multiple_empty_volumes</span></code></li><li id="type-add_error.File_exists" class="def variant constructor anchored"><a href="#type-add_error.File_exists" class="anchor"></a><code><span>| </span><span>`File_exists <span class="keyword">of</span> string</span></code></li><li id="type-add_error.Invalid_parent_directory" class="def variant constructor anchored"><a href="#type-add_error.Invalid_parent_directory" class="anchor"></a><code><span>| </span><span>`Invalid_parent_directory</span></code></li></ol><code><span> ]</span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-v"><a href="#val-v" class="anchor"></a><code><span><span class="keyword">val</span> v : 
  <span><span class="label">readonly</span>:bool <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">volume_num</span>:int <span class="arrow">&#45;&gt;</span></span>
  <span>string <span class="arrow">&#45;&gt;</span></span>
  <span><span>(<a href="#type-t">t</a>, <span>[&gt; <a href="#type-open_error">open_error</a> ]</span>)</span> <span class="xref-unresolved">Stdlib</span>.result</span></span></code></div><div class="spec-doc"><p><code>v ~readonly ~volume_num lower_root</code> loads all volumes located in the directory <code>lower_root</code>.</p><p><code>volume_num</code> is the number of volumes that are expected in <code>lower_root</code>. 0 is valid for an empty lower.</p><p><code>Error `Volume_missing path</code> is returned if an expected volume is not on disk, with the path to first volume that is missing. This can happen if <code>volume_num</code> is larger than the number of volumes on disk, or if one of the volume directories has been renamed accidentally.</p><p>If <code>readonly</code> is false, no write operations are allowed.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-reload"><a href="#val-reload" class="anchor"></a><code><span><span class="keyword">val</span> reload : <span><span class="label">volume_num</span>:int <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><span>(unit, <span>[&gt; <a href="#type-open_error">open_error</a> ]</span>)</span> <span class="xref-unresolved">Stdlib</span>.result</span></span></code></div><div class="spec-doc"><p><code>reload ~volume_num t</code> reloads volumes located in the root directory of <code>t</code>, using <code>volume_num</code> as the expected number of volumes.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-close"><a href="#val-close" class="anchor"></a><code><span><span class="keyword">val</span> close : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><span>(unit, <span>[&gt; <a href="#type-close_error">close_error</a> ]</span>)</span> <span class="xref-unresolved">Stdlib</span>.result</span></span></code></div><div class="spec-doc"><p><code>close t</code> closes all resources opened by <code>t</code>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-volume_num"><a href="#val-volume_num" class="anchor"></a><code><span><span class="keyword">val</span> volume_num : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> int</span></code></div><div class="spec-doc"><p><code>volume_num t</code> returns the number of volumes in the lower <code>t</code>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-add_volume"><a href="#val-add_volume" class="anchor"></a><code><span><span class="keyword">val</span> add_volume : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><span>(<a href="Volume/index.html#type-t">Volume.t</a>, <span>[&gt; <a href="#type-add_error">add_error</a> ]</span>)</span> <span class="xref-unresolved">Stdlib</span>.result</span></span></code></div><div class="spec-doc"><p><code>add_volume t</code> adds a new empty volume to <code>t</code>.</p><p>If there is already an empty volume, <code>Error `Multiple_empty_volumes</code> is returned. Only one empty volume is allowed.</p><p>If <code>t</code> is read-only, <code>Error `Ro_not_allowed</code> is returned.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-find_volume"><a href="#val-find_volume" class="anchor"></a><code><span><span class="keyword">val</span> find_volume : <span><span class="label">off</span>:<span class="xref-unresolved">Optint</span>.Int63.t <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="Volume/index.html#type-t">Volume.t</a> option</span></span></code></div><div class="spec-doc"><p><code>find_volume ~off t</code> returns the <a href="Volume/index.html"><code>Volume</code></a> that contains <code>off</code>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-read_exn"><a href="#val-read_exn" class="anchor"></a><code><span><span class="keyword">val</span> read_exn : 
  <span><span class="label">off</span>:<span class="xref-unresolved">Optint</span>.Int63.t <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">len</span>:int <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?volume</span>:<a href="#type-volume_identifier">volume_identifier</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span>
  <span>bytes <span class="arrow">&#45;&gt;</span></span>
  <a href="#type-volume_identifier">volume_identifier</a></span></code></div><div class="spec-doc"><p><code>read_exn ~off ~len ~volume t b</code> will read <code>len</code> bytes from a global <code>off</code> located in the volume with identifier <code>volume</code>. The volume identifier of the volume where the read occurs is returned.</p><p>If <code>volume</code> is not provided, <a href="#val-find_volume"><code>find_volume</code></a> will be used to attempt to locate the correct volume for the read.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-set_readonly"><a href="#val-set_readonly" class="anchor"></a><code><span><span class="keyword">val</span> set_readonly : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span>bool <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p><code>set_readonly t flag</code> changes the writing permission of the lower layer (where <code>true</code> is read only). This should only be called by the GC worker to temporarily allow RW before calling <a href="#val-archive_seq_exn"><code>archive_seq_exn</code></a>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-archive_seq_exn"><a href="#val-archive_seq_exn" class="anchor"></a><code><span><span class="keyword">val</span> archive_seq_exn : 
  <span><span class="label">upper_root</span>:string <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">generation</span>:int <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">to_archive</span>:<span><span>(<span class="xref-unresolved">Optint</span>.Int63.t * <span>string <a href="../../../../../../irmin/Irmin/Export_for_backends/Seq/index.html#type-t">Irmin.Export_for_backends.Seq.t</a></span>)</span> list</span> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span>
  <a href="#type-volume_identifier">volume_identifier</a></span></code></div><div class="spec-doc"><p><code>archive_seq ~upper_root ~generation ~to_archive t</code> is called by the GC worker during the creation of the new <code>generation</code> to archive <code>to_archive</code> in the lower layer and returns the identifier of the volume where data was appended.</p><p>It is the only write operation allowed on the lower layer, and it makes no observable change as the control file is left untouched : instead new changes are written to volume.gen.control, which is swapped during GC finalization.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-read_range_exn"><a href="#val-read_range_exn" class="anchor"></a><code><span><span class="keyword">val</span> read_range_exn : 
  <span><span class="label">off</span>:<span class="xref-unresolved">Optint</span>.Int63.t <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">min_len</span>:int <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">max_len</span>:int <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?volume</span>:<a href="#type-volume_identifier">volume_identifier</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span>
  <span>bytes <span class="arrow">&#45;&gt;</span></span>
  int * <a href="#type-volume_identifier">volume_identifier</a></span></code></div><div class="spec-doc"><p>Same as <code>read_exn</code> but will read at least <code>min_len</code> bytes and at most <code>max_len</code>. Returns the read length and the volume identifier from which the data was fetched.</p></div></div><div class="odoc-spec"><div class="spec type subst anchored" id="type-create_error"><a href="#type-create_error" class="anchor"></a><code><span><span class="keyword">type</span> create_error</span><span> := </span><span>[ </span></code><ol><li id="type-create_error.open_error" class="def variant type anchored"><a href="#type-create_error.open_error" class="anchor"></a><code><span>| </span><span><a href="#type-open_error">open_error</a></span></code></li><li id="type-create_error.close_error" class="def variant type anchored"><a href="#type-create_error.close_error" class="anchor"></a><code><span>| </span><span><a href="#type-close_error">close_error</a></span></code></li><li id="type-create_error.add_error" class="def variant type anchored"><a href="#type-create_error.add_error" class="anchor"></a><code><span>| </span><span><a href="#type-add_error">add_error</a></span></code></li><li id="type-create_error.Sys_error" class="def variant constructor anchored"><a href="#type-create_error.Sys_error" class="anchor"></a><code><span>| </span><span>`Sys_error <span class="keyword">of</span> string</span></code></li></ol><code><span> ]</span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-create_from"><a href="#val-create_from" class="anchor"></a><code><span><span class="keyword">val</span> create_from : 
  <span><span class="label">src</span>:string <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">dead_header_size</span>:int <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">size</span>:<span class="xref-unresolved">Optint</span>.Int63.t <span class="arrow">&#45;&gt;</span></span>
  <span>string <span class="arrow">&#45;&gt;</span></span>
  <span><span>(unit, <span>[&gt; <a href="#type-create_error">create_error</a> ]</span>)</span> <span class="xref-unresolved">Stdlib</span>.result</span></span></code></div><div class="spec-doc"><p><code>create_from ~src ~dead_header_size ~size lower_root</code> initializes the first lower volume in the directory <code>lower_root</code> by moving the suffix file <code>src</code> with end offset <code>size</code>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-swap"><a href="#val-swap" class="anchor"></a><code><span><span class="keyword">val</span> swap : 
  <span><span class="label">volume</span>:<a href="#type-volume_identifier">volume_identifier</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">generation</span>:int <span class="arrow">&#45;&gt;</span></span>
  <span><span class="label">volume_num</span>:int <span class="arrow">&#45;&gt;</span></span>
  <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span>(unit, <span>[&gt; <span>`Volume_not_found of string</span> <span><span>| `Sys_error</span> of string</span> <span>| <a href="#type-open_error">open_error</a></span> ]</span>)</span>
    <span class="xref-unresolved">Stdlib</span>.result</span></span></code></div><div class="spec-doc"><p><code>swap ~volume ~generation ~volume_num t</code> will rename a new volume control file in <code>volume</code> for <code>generation</code> of GC and then reload the lower with <code>volume_num</code> volumes.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-cleanup"><a href="#val-cleanup" class="anchor"></a><code><span><span class="keyword">val</span> cleanup : 
  <span><span class="label">generation</span>:int <span class="arrow">&#45;&gt;</span></span>
  <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span>(unit, <span>[&gt; <span>`Sys_error of string</span> ]</span>)</span> <span class="xref-unresolved">Stdlib</span>.result</span></span></code></div><div class="spec-doc"><p><code>cleanup ~generation t</code> will attempt to cleanup the appendable volume if a GC crash has occurred.</p></div></div></div></body></html>
