<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Pack_key (irmin-pack.Irmin_pack_unix.Pack_key)</title><link rel="stylesheet" href="../../../_odoc_support/odoc.css"/><meta charset="utf-8"/><meta name="generator" content="odoc 2.2.0"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../../_odoc_support/highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body class="odoc"><nav class="odoc-nav"><a href="../index.html">Up</a> â€“ <a href="../../index.html">irmin-pack</a> &#x00BB; <a href="../index.html">Irmin_pack_unix</a> &#x00BB; Pack_key</nav><header class="odoc-preamble"><h1>Module <code><span>Irmin_pack_unix.Pack_key</span></code></h1></header><nav class="odoc-toc"><ul><li><a href="#undereferencable-keys">Undereferencable keys</a></li></ul></nav><div class="odoc-content"><div class="odoc-spec"><div class="spec type anchored" id="type-t"><a href="#type-t" class="anchor"></a><code><span><span class="keyword">type</span> <span>'hash t</span></span></code></div><div class="spec-doc"><p>The type of <i>keys</i> referencing values stored in the <code>irmin-pack</code> backend.</p></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-safe"><a href="#type-safe" class="anchor"></a><code><span><span class="keyword">type</span> safe</span><span> = </span></code><ol><li id="type-safe.SAFE" class="def variant constructor anchored"><a href="#type-safe.SAFE" class="anchor"></a><code><span>| </span><span><span class="constructor">SAFE</span></span></code></li></ol></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-unsafe"><a href="#type-unsafe" class="anchor"></a><code><span><span class="keyword">and</span> unsafe</span><span> = </span></code><ol><li id="type-unsafe.UNSAFE" class="def variant constructor anchored"><a href="#type-unsafe.UNSAFE" class="anchor"></a><code><span>| </span><span><span class="constructor">UNSAFE</span></span></code></li></ol></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-unsafe_state"><a href="#type-unsafe_state" class="anchor"></a><code><span><span class="keyword">type</span> <span>('hash, _) unsafe_state</span></span><span> = <span class="keyword">private</span> </span></code><ol><li id="type-unsafe_state.Direct" class="def variant constructor anchored"><a href="#type-unsafe_state.Direct" class="anchor"></a><code><span>| </span><span><span class="constructor">Direct</span> : </span><span>{</span></code><ol><li id="type-unsafe_state.hash" class="def record field anchored"><a href="#type-unsafe_state.hash" class="anchor"></a><code><span>hash : <span class="type-var">'hash</span>;</span></code></li><li id="type-unsafe_state.offset" class="def record field anchored"><a href="#type-unsafe_state.offset" class="anchor"></a><code><span>offset : <span class="xref-unresolved">Optint</span>.Int63.t;</span></code></li><li id="type-unsafe_state.length" class="def record field anchored"><a href="#type-unsafe_state.length" class="anchor"></a><code><span>length : int;</span></code></li><li id="type-unsafe_state.volume_identifier" class="def record field anchored"><a href="#type-unsafe_state.volume_identifier" class="anchor"></a><code><span>volume_identifier : <span><a href="../Lower/index.html#type-volume_identifier">Lower.volume_identifier</a> option</span>;</span></code></li></ol><code><span>}</span><span> <span class="arrow">&#45;&gt;</span> <span><span>(<span class="type-var">'hash</span>, <a href="#type-safe">safe</a>)</span> <a href="#type-unsafe_state">unsafe_state</a></span></span></code><div class="def-doc"><span class="comment-delim">(*</span><p>A &quot;direct&quot; pointer to a value stored at <code>offset</code> in the pack-file (with hash <code>hash</code> and length <code>length</code>). Such keys can be dereferenced from the store with a single IO read, without needing to consult the index.</p><p>They are built in-memory (e.g. after adding a fresh value to the pack file), but have no corresponding encoding format, as the pack format keeps length information with the values themselves.</p><p>When decoding a inode, which references its children as single offsets, we fetch the length information of the child at the same time as fetching its hash (which we must do anyway in order to do an integrity check), creating keys of this form.</p><span class="comment-delim">*)</span></div></li><li id="type-unsafe_state.Indexed" class="def variant constructor anchored"><a href="#type-unsafe_state.Indexed" class="anchor"></a><code><span>| </span><span><span class="constructor">Indexed</span> : <span class="type-var">'hash</span> <span class="arrow">&#45;&gt;</span> <span><span>(<span class="type-var">'hash</span>, <a href="#type-safe">safe</a>)</span> <a href="#type-unsafe_state">unsafe_state</a></span></span></code><div class="def-doc"><span class="comment-delim">(*</span><p>A pointer to an object in the pack file that is indexed. Reading the object necessitates consulting the index, after which the key can be promoted to <a href="#type-unsafe_state.Direct"><code>Direct</code></a>.</p><p>Such keys result from decoding pointers to other store objects (nodes or commits) from commits or from the branch store.</p><span class="comment-delim">*)</span></div></li><li id="type-unsafe_state.Offset" class="def variant constructor anchored"><a href="#type-unsafe_state.Offset" class="anchor"></a><code><span>| </span><span><span class="constructor">Offset</span> : <span class="xref-unresolved">Optint</span>.Int63.t <span class="arrow">&#45;&gt;</span> <span><span>(<span class="type-var">'hash</span>, <a href="#type-unsafe">unsafe</a>)</span> <a href="#type-unsafe_state">unsafe_state</a></span></span></code><div class="def-doc"><span class="comment-delim">(*</span><p>Same as <code>Direct</code>, but the hash and length of the object have not been fetched. Only used to speed up the GC traversal.</p><span class="comment-delim">*)</span></div></li></ol></div><div class="spec-doc"><p>The internal state of a key (read with <a href="#val-inspect"><code>inspect</code></a>).</p><p>Invariant: keys of the form <a href="#type-unsafe_state.Indexed"><code>Indexed</code></a> always reference values that have entries in the index (as otherwise these keys could not be dereferenced).</p></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-state"><a href="#type-state" class="anchor"></a><code><span><span class="keyword">type</span> <span>'hash state</span></span><span> = <span><span>(<span class="type-var">'hash</span>, <a href="#type-safe">safe</a>)</span> <a href="#type-unsafe_state">unsafe_state</a></span></span></code></div></div><h3 id="undereferencable-keys"><a href="#undereferencable-keys" class="anchor"></a>Undereferencable keys</h3><p>A key <code>k</code> is &quot;undereferencable&quot; with respect to some store handle <code>t</code> if <code>find t k &lt;&gt; Some _</code>. Such keys should not arise during regular operation of a single Irmin repository, but are still technically constructible in the following ways:</p><ul><li><b>storage corruption</b>. When decoding a key from disk, we may not immediately check that it is dereferenceable for performance reasons. In this case, any corruption to the key (or the referenced section of the store) will be discovered on attempted <code>find</code> (or <code>mem</code>).</li></ul><ul><li><b>passing keys between store handles</b>. Read-only handles on a pack store must explicitly <i>reload</i> to observe recent writes to the store. This means that any keys built by a read-write instance and passed to a read-only instance will be undereferencable until that reader has reloaded.</li></ul><ul><li><b>passing keys between repositories</b>. Keys created for one Irmin repository may not be dereferenced with respect to another by design.</li></ul><div class="odoc-spec"><div class="spec value anchored" id="val-inspect"><a href="#val-inspect" class="anchor"></a><code><span><span class="keyword">val</span> inspect : <span><span><span class="type-var">'hash</span> <a href="#type-t">t</a></span> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'hash</span> <a href="#type-state">state</a></span></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-v_direct"><a href="#val-v_direct" class="anchor"></a><code><span><span class="keyword">val</span> v_direct : 
  <span>offset:<span class="xref-unresolved">Optint</span>.Int63.t <span class="arrow">&#45;&gt;</span></span>
  <span>length:int <span class="arrow">&#45;&gt;</span></span>
  <span>?volume_identifier:<a href="../Lower/index.html#type-volume_identifier">Lower.volume_identifier</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="type-var">'h</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="type-var">'h</span> <a href="#type-t">t</a></span></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-v_indexed"><a href="#val-v_indexed" class="anchor"></a><code><span><span class="keyword">val</span> v_indexed : <span><span class="type-var">'h</span> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'h</span> <a href="#type-t">t</a></span></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-v_offset"><a href="#val-v_offset" class="anchor"></a><code><span><span class="keyword">val</span> v_offset : <span><span class="xref-unresolved">Optint</span>.Int63.t <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'h</span> <a href="#type-t">t</a></span></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-promote_exn"><a href="#val-promote_exn" class="anchor"></a><code><span><span class="keyword">val</span> promote_exn : 
  <span>offset:<span class="xref-unresolved">Optint</span>.Int63.t <span class="arrow">&#45;&gt;</span></span>
  <span>length:int <span class="arrow">&#45;&gt;</span></span>
  <span>?volume_identifier:<a href="../Lower/index.html#type-volume_identifier">Lower.volume_identifier</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span class="type-var">'h</span> <a href="#type-t">t</a></span> <span class="arrow">&#45;&gt;</span></span>
  unit</span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-set_volume_identifier_exn"><a href="#val-set_volume_identifier_exn" class="anchor"></a><code><span><span class="keyword">val</span> set_volume_identifier_exn : 
  <span>volume_identifier:<span><a href="../Lower/index.html#type-volume_identifier">Lower.volume_identifier</a> option</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span class="type-var">'h</span> <a href="#type-t">t</a></span> <span class="arrow">&#45;&gt;</span></span>
  unit</span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-to_offset"><a href="#val-to_offset" class="anchor"></a><code><span><span class="keyword">val</span> to_offset : <span><span><span class="type-var">'h</span> <a href="#type-t">t</a></span> <span class="arrow">&#45;&gt;</span></span> <span><span class="xref-unresolved">Optint</span>.Int63.t option</span></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-to_hash"><a href="#val-to_hash" class="anchor"></a><code><span><span class="keyword">val</span> to_hash : <span><span><span class="type-var">'h</span> <a href="#type-t">t</a></span> <span class="arrow">&#45;&gt;</span></span> <span class="type-var">'h</span></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-to_length"><a href="#val-to_length" class="anchor"></a><code><span><span class="keyword">val</span> to_length : <span><span><span class="type-var">'h</span> <a href="#type-t">t</a></span> <span class="arrow">&#45;&gt;</span></span> <span>int option</span></span></code></div></div><div class="odoc-spec"><div class="spec module-type anchored" id="module-type-S"><a href="#module-type-S" class="anchor"></a><code><span><span class="keyword">module</span> <span class="keyword">type</span> <a href="module-type-S/index.html">S</a></span><span> = <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div></div><div class="odoc-spec"><div class="spec module anchored" id="module-Make"><a href="#module-Make" class="anchor"></a><code><span><span class="keyword">module</span> <a href="Make/index.html">Make</a></span><span> (<a href="Make/argument-1-Hash/index.html">Hash</a> : <a href="../../../irmin/Irmin/Hash/module-type-S/index.html">Irmin.Hash.S</a>) : <a href="module-type-S/index.html">S</a> <span class="keyword">with</span> <span><span class="keyword">type</span> <a href="module-type-S/index.html#type-hash">hash</a> = <a href="Make/argument-1-Hash/index.html#type-t">Hash.t</a></span></span></code></div></div><div class="odoc-spec"><div class="spec module-type anchored" id="module-type-Store_spec"><a href="#module-type-Store_spec" class="anchor"></a><code><span><span class="keyword">module</span> <span class="keyword">type</span> <a href="module-type-Store_spec/index.html">Store_spec</a></span><span> = <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div></div><div class="odoc-spec"><div class="spec module anchored" id="module-Store_spec"><a href="#module-Store_spec" class="anchor"></a><code><span><span class="keyword">module</span> <a href="Store_spec/index.html">Store_spec</a></span><span> : <a href="module-type-Store_spec/index.html">Store_spec</a></span></code></div></div></div></body></html>