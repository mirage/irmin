<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Exponential_moving_average (irmin-bench.Irmin_traces.Trace_stat_summary_utils.Exponential_moving_average)</title><link rel="stylesheet" href="../../../../odoc.support/odoc.css"/><meta charset="utf-8"/><meta name="generator" content="odoc 2.2.0"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../../../odoc.support/highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body class="odoc"><nav class="odoc-nav"><a href="../index.html">Up</a> â€“ <a href="../../../index.html">irmin-bench</a> &#x00BB; <a href="../../index.html">Irmin_traces</a> &#x00BB; <a href="../index.html">Trace_stat_summary_utils</a> &#x00BB; Exponential_moving_average</nav><header class="odoc-preamble"><h1>Module <code><span>Trace_stat_summary_utils.Exponential_moving_average</span></code></h1><p>Functional Exponential Moving Average (EMA).</p></header><div class="odoc-content"><div class="odoc-spec"><div class="spec type anchored" id="type-t"><a href="#type-t" class="anchor"></a><code><span><span class="keyword">type</span> t</span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-create"><a href="#val-create" class="anchor"></a><code><span><span class="keyword">val</span> create : <span>?relevance_threshold:float <span class="arrow">&#45;&gt;</span></span> <span>float <span class="arrow">&#45;&gt;</span></span> <a href="#type-t">t</a></span></code></div><div class="spec-doc"><p><code>create ?relevance_threshold m</code> is <code>ema</code>, a functional exponential moving average. <code>1. -. m</code> is the fraction of what's forgotten of the past during each <code>update</code>.</p><p>The value represented by <code>ema</code> can be retrieved using <code>peek_exn ema</code> or <code>peek_or_nan ema</code>.</p><p>When <code>m = 0.</code>, all the past is forgotten on each update and each forget. <code>peek_exn ema</code> is either the latest sample fed to an update function or <code>nan</code>.</p><p>When <code>m</code> approaches <code>1.</code>, <code>peek_exn ema</code> tends to be the mean of all the samples seen in the past.</p><p>See https://en.wikipedia.org/wiki/Moving_average#Exponential_moving_average</p><p>Relevance</p><p>The value represented by <code>ema</code> is built from the <em>history</em> of samples shown through <code>update(_batch)</code>. When that history is empty, the value can't be calculated, and when the history is too small, or too distant because of calls to <code>forget(_batch)</code>, the represented value is very noisy.</p><p><code>relevance_threshold</code> is a threshold on <code>ema</code>'s inner <code>void_fraction</code>, below which the represented value should be considered relevant, i.e. <code>peek_or_nan ema</code> is not NaN.</p><p>Before any call to <code>update(_batch)</code>, the represented value is always irrelevant.</p><p>After a sufficient number of updates (e.g. 1 update in general), the represented value gets relevant.</p><p>After a sufficient number of forgets, the represented value gets irrelevant again.</p><p>A good value for <code>relevance_threshold</code> is between <code>momentum</code> and <code>1.</code>, so that right after a call to <code>update</code>, the value is always relevant.</p><p>Commutativity</p><p>Adding together two curves independently built with an EMA, is equivalent to adding the samples beforehand, and using a single EMA.</p><p>In a more more formal way:</p><p>Let <code>a</code>, <code>b</code> be vectors of real values of similar length.</p><p>Let <code>ema(x)</code> be the <code>Exponential_moving_average.map momentum</code> function (<code>float list -&gt; float list</code>);</p><p>Let <code>*</code>, <code>+</code> and <code>/</code> be the element-wise vector multiplication, addition and division.</p><p>Then <code>ema(a + b)</code> is <code>ema(a) + ema(b)</code>.</p><p>The same is not true for multiplication and division, <code>ema(a * b)</code> is not <code>ema(a) * ema(b)</code>, but <code>exp(ema(log(a * b)))</code> is <code>exp(ema(log(a))) * exp(ema(log(b)))</code> when all values in <code>a</code> and <code>b</code> are strictly greater than 0.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-from_half_life"><a href="#val-from_half_life" class="anchor"></a><code><span><span class="keyword">val</span> from_half_life : <span>?relevance_threshold:float <span class="arrow">&#45;&gt;</span></span> <span>float <span class="arrow">&#45;&gt;</span></span> <a href="#type-t">t</a></span></code></div><div class="spec-doc"><p><code>from_half_life hl</code> is <code>ema</code>, a functional exponential moving average. After <code>hl</code> calls to <code>update</code>, half of the past is forgotten.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-from_half_life_ratio"><a href="#val-from_half_life_ratio" class="anchor"></a><code><span><span class="keyword">val</span> from_half_life_ratio : <span>?relevance_threshold:float <span class="arrow">&#45;&gt;</span></span> <span>float <span class="arrow">&#45;&gt;</span></span> <span>float <span class="arrow">&#45;&gt;</span></span> <a href="#type-t">t</a></span></code></div><div class="spec-doc"><p><code>from_half_life_ratio hl_ratio step_count</code> is <code>ema</code>, a functional exponential moving average. After <code>hl_ratio * step_count</code> calls to <code>update</code>, half of the past is forgotten.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-map"><a href="#val-map" class="anchor"></a><code><span><span class="keyword">val</span> map : <span>?relevance_threshold:float <span class="arrow">&#45;&gt;</span></span> <span>float <span class="arrow">&#45;&gt;</span></span> <span><span>float list</span> <span class="arrow">&#45;&gt;</span></span> <span>float list</span></span></code></div><div class="spec-doc"><p><code>map momentum vec0</code> is <code>vec1</code>, a list of float with the same length as <code>vec0</code>, where the values have been locally averaged.</p><p>The first element of <code>vec1</code> is also the first element of <code>vec0</code>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-update"><a href="#val-update" class="anchor"></a><code><span><span class="keyword">val</span> update : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span>float <span class="arrow">&#45;&gt;</span></span> <a href="#type-t">t</a></span></code></div><div class="spec-doc"><p>Feed a new sample to the EMA. If the sample is not finite (i.e., NaN or infinite), the represented won't be either.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-update_batch"><a href="#val-update_batch" class="anchor"></a><code><span><span class="keyword">val</span> update_batch : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span>float <span class="arrow">&#45;&gt;</span></span> <span>float <span class="arrow">&#45;&gt;</span></span> <a href="#type-t">t</a></span></code></div><div class="spec-doc"><p><code>update_batch ema p s</code> is equivalent to calling <code>update</code> <code>s</code> times. Modulo floating point errors.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-forget"><a href="#val-forget" class="anchor"></a><code><span><span class="keyword">val</span> forget : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <a href="#type-t">t</a></span></code></div><div class="spec-doc"><p><code>forget ema</code> forgets some of the past without the need for samples. The represented value doesn't change.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-forget_batch"><a href="#val-forget_batch" class="anchor"></a><code><span><span class="keyword">val</span> forget_batch : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span>float <span class="arrow">&#45;&gt;</span></span> <a href="#type-t">t</a></span></code></div><div class="spec-doc"><p><code>forget_batch ema s</code> is equivalent to calling <code>forget</code> <code>s</code> times. Modulo floating point errors.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-is_relevant"><a href="#val-is_relevant" class="anchor"></a><code><span><span class="keyword">val</span> is_relevant : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> bool</span></code></div><div class="spec-doc"><p>Indicates whether or not <code>peek_exn</code> can be called without raising an exception.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-peek_exn"><a href="#val-peek_exn" class="anchor"></a><code><span><span class="keyword">val</span> peek_exn : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> float</span></code></div><div class="spec-doc"><p>Read the EMA value.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-peek_or_nan"><a href="#val-peek_or_nan" class="anchor"></a><code><span><span class="keyword">val</span> peek_or_nan : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> float</span></code></div><div class="spec-doc"><p>Read the EMA value.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-momentum"><a href="#val-momentum" class="anchor"></a><code><span><span class="keyword">val</span> momentum : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> float</span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-hidden_state"><a href="#val-hidden_state" class="anchor"></a><code><span><span class="keyword">val</span> hidden_state : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> float</span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-void_fraction"><a href="#val-void_fraction" class="anchor"></a><code><span><span class="keyword">val</span> void_fraction : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> float</span></code></div></div></div></body></html>