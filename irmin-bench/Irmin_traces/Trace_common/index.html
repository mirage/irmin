<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Trace_common (irmin-bench.Irmin_traces.Trace_common)</title><link rel="stylesheet" href="../../../odoc.css"/><meta charset="utf-8"/><meta name="generator" content="odoc 2.1.1"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../../highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body class="odoc"><nav class="odoc-nav"><a href="../index.html">Up</a> â€“ <a href="../../index.html">irmin-bench</a> &#x00BB; <a href="../index.html">Irmin_traces</a> &#x00BB; Trace_common</nav><header class="odoc-preamble"><h1>Module <code><span>Irmin_traces.Trace_common</span></code></h1><p><code>Trace_common</code> contains utility to simplify the management of files using the following layout:</p><pre>    - Magic (Magic.t, 8 bytes)
    - Version (int32, 4 bytes)
    - Length of header (varint, &gt;=1 byte)
    - Header (header_t, _ bytes)
    - Arbitrary long series of rows, of unspecified length, each prefixed by their length:
      - Length of row (varint, &gt;=1 byte)
      - Row (row_t, _ bytes)</pre><p>This file is meant to be used from Tezos. OCaml version 4.09 and the 32bit architecture should be supported.</p></header><nav class="odoc-toc"><ul><li><a href="#example">Example</a></li></ul></nav><div class="odoc-content"><h4 id="example"><a href="#example" class="anchor"></a>Example</h4><pre><code>module Example = struct
  module V2 = struct
    let version = 2

    type header = unit [@@deriving repr]
    type row = [ `A | `B | `C ] [@@deriving repr]
  end

  module V1 = struct
    let version = 1

    type header = unit [@@deriving repr]
    type row = [ `A | `B ] [@@deriving repr]

    let to_v2 x = (x :&gt; V2.row)
  end

  module V0 = struct
    let version = 0

    type header = unit [@@deriving repr]
    type row = [ `A of int | `B of int ] [@@deriving repr]

    let to_v1 = function `A _ -&gt; `A | `B _ -&gt; `B
  end

  module Latest = V2
  include Latest

  include Trace_common.Io (struct
    module Latest = Latest

    let magic = Trace_common.Magic.of_string &quot;Magique_&quot;

    let get_version_converter = function
      | 2 -&gt;
          Trace_common.Version_converter
            {
              header_t = V2.header_t;
              row_t = V2.row_t;
              upgrade_header = Fun.id;
              upgrade_row = Fun.id;
            }
      | 1 -&gt;
          Version_converter
            {
              header_t = V1.header_t;
              row_t = V1.row_t;
              upgrade_header = Fun.id;
              upgrade_row = V1.to_v2;
            }
      | 0 -&gt;
          Version_converter
            {
              header_t = V0.header_t;
              row_t = V0.row_t;
              upgrade_header = Fun.id;
              upgrade_row = (fun x -&gt; V0.to_v1 x |&gt; V1.to_v2);
            }
      | i -&gt; Fmt.invalid_arg &quot;Unknown Example version %d&quot; i
  end)
end</code></pre><div class="odoc-spec"><div class="spec module" id="module-Seq" class="anchored"><a href="#module-Seq" class="anchor"></a><code><span><span class="keyword">module</span> <a href="Seq/index.html">Seq</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div></div><div class="odoc-spec"><div class="spec module" id="module-Magic" class="anchored"><a href="#module-Magic" class="anchor"></a><code><span><span class="keyword">module</span> <a href="Magic/index.html">Magic</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div></div><div class="odoc-spec"><div class="spec type" id="type-version_converter'" class="anchored"><a href="#type-version_converter'" class="anchor"></a><code><span><span class="keyword">type</span> <span>('latest_header, 'latest_row, 'header, 'row) version_converter'</span></span><span> = </span><span>{</span></code><table><tr id="type-version_converter'.header_t" class="anchored"><td class="def record field"><a href="#type-version_converter'.header_t" class="anchor"></a><code><span>header_t : <span><span class="type-var">'header</span> <span class="xref-unresolved">Repr</span>.ty</span>;</span></code></td></tr><tr id="type-version_converter'.row_t" class="anchored"><td class="def record field"><a href="#type-version_converter'.row_t" class="anchor"></a><code><span>row_t : <span><span class="type-var">'row</span> <span class="xref-unresolved">Repr</span>.ty</span>;</span></code></td></tr><tr id="type-version_converter'.upgrade_header" class="anchored"><td class="def record field"><a href="#type-version_converter'.upgrade_header" class="anchor"></a><code><span>upgrade_header : <span><span class="type-var">'header</span> <span class="arrow">&#45;&gt;</span></span> <span class="type-var">'latest_header</span>;</span></code></td></tr><tr id="type-version_converter'.upgrade_row" class="anchored"><td class="def record field"><a href="#type-version_converter'.upgrade_row" class="anchor"></a><code><span>upgrade_row : <span><span class="type-var">'row</span> <span class="arrow">&#45;&gt;</span></span> <span class="type-var">'latest_row</span>;</span></code></td></tr></table><code><span>}</span></code></div><div class="spec-doc"><p>Contains everything needed to read a file as if it is written with the lastest version.</p></div></div><div class="odoc-spec"><div class="spec type" id="type-version_converter" class="anchored"><a href="#type-version_converter" class="anchor"></a><code><span><span class="keyword">type</span> <span>('latest_header, 'latest_row) version_converter</span></span><span> = </span></code><table><tr id="type-version_converter.Version_converter" class="anchored"><td class="def variant constructor"><a href="#type-version_converter.Version_converter" class="anchor"></a><code><span>| </span><span><span class="constructor">Version_converter</span> : <span><span>( <span class="type-var">'latest_header</span>, <span class="type-var">'latest_row</span>, <span class="type-var">'header</span>, <span class="type-var">'row</span> )</span>
                      <a href="#type-version_converter'">version_converter'</a></span> <span class="arrow">&#45;&gt;</span> <span><span>( <span class="type-var">'latest_header</span>, <span class="type-var">'latest_row</span> )</span>
                                              <a href="#type-version_converter">version_converter</a></span></span></code></td></tr></table></div><div class="spec-doc"><p>A box containing the above record</p></div></div><div class="odoc-spec"><div class="spec module-type" id="module-type-File_format" class="anchored"><a href="#module-type-File_format" class="anchor"></a><code><span><span class="keyword">module</span> <span class="keyword">type</span> <a href="module-type-File_format/index.html">File_format</a></span><span> = <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div></div><div class="odoc-spec"><div class="spec module" id="module-Var_int" class="anchored"><a href="#module-Var_int" class="anchor"></a><code><span><span class="keyword">module</span> <a href="Var_int/index.html">Var_int</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div><div class="spec-doc"><p>Very similar to what can be found in &quot;repr/type_binary.ml&quot;, but working straight off channels.</p></div></div><div class="odoc-spec"><div class="spec module" id="module-Io" class="anchored"><a href="#module-Io" class="anchor"></a><code><span><span class="keyword">module</span> <a href="Io/index.html">Io</a></span><span> (<a href="Io/argument-1-Ff/index.html">Ff</a> : <a href="module-type-File_format/index.html">File_format</a>) : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div><div class="spec-doc"><p>Derive the IO operations from a file format. Only the write operations are performance sensitive, the read operations are not.</p></div></div></div></body></html>